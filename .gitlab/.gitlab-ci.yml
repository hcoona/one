default:
  image:
    name: hcoona/ubuntu-llvm:focal-14
    entrypoint: [""]
  before_script:
    - mkdir -p $CI_PROJECT_DIR/.cache/bazelisk/bin
    - test \! -x $CI_PROJECT_DIR/.cache/bazelisk/bin/bazel && wget https://github.com/bazelbuild/bazelisk/releases/download/v1.11.0/bazelisk-linux-amd64 -O $CI_PROJECT_DIR/.cache/bazelisk/bin/bazel
    - chmod +x $CI_PROJECT_DIR/.cache/bazelisk/bin/bazel
    - export PATH=$CI_PROJECT_DIR/.cache/bazelisk/bin:$PATH
    - mkdir -p $CI_PROJECT_DIR/.cache/bazel/disk_cache
    - mkdir -p $CI_PROJECT_DIR/.cache/bazel/repository_cache
    - echo "build --disk_cache=$CI_PROJECT_DIR/.cache/bazel/disk_cache" >> .bazelrc
    - echo "build --repository_cache=$CI_PROJECT_DIR/.cache/bazel/repository_cache" >> .bazelrc
    - echo "startup --batch_cpu_scheduling" >> .bazelrc
    - tools/setup_clang.sh /usr/lib/llvm-14

variables:
  CACHE_FALLBACK_KEY: main
  DOCKER_DRIVER: overlay2

cache:
  - key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .bazel_output/
      - .cache/

stages:
  - build
  - test

build:
  stage: build
  script:
    - bazel --output_base=.bazel_output build --config=libc++ //...

test:
  stage: test
  script:
    - bazel --output_base=.bazel_output test -c opt --config=clang-asan -- //... -//third_party/wangle:SSLContextManagerTest
  artifacts:
    paths:
      - .bazel_output/execroot/com_github_hcoona_one/bazel-out/**/testlogs/**
    expire_in: 2 days
    when: on_failure
