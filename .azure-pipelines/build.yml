jobs:
- job: build
  timeoutInMinutes: 240
  steps:
  - checkout: self
    clean: true
  - task: AzureKeyVault@2
    displayName: Get ApiKey from Azure KeyVault
    inputs:
      connectedServiceName: 'Isolated'
      keyVaultName: 'shuaizhang-akv'
      secretsFilter: 'BuildBuddyApiKey'
  - bash: tools/setup_clang.sh /usr/lib/llvm-14
    displayName: Setup for Bazel build with clang
  - script: >
      bazel
      --batch_cpu_scheduling
      build
      --noshow_loading_progress
      --show_progress_rate_limit=5
      --verbose_failures
      --config=buildbuddy
      --remote_header=x-buildbuddy-api-key=$(BuildBuddyApiKey)
      --build_metadata=BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
      --build_metadata=COMMIT_SHA=$(git rev-parse HEAD)
      --build_metadata=ROLE=CI
      --config=libc++
      //...
    displayName: Build project

- job: test
  timeoutInMinutes: 240
  steps:
  - checkout: self
    clean: true
  - task: AzureKeyVault@2
    displayName: Get ApiKey from Azure KeyVault
    inputs:
      connectedServiceName: 'Isolated'
      keyVaultName: 'shuaizhang-akv'
      secretsFilter: 'BuildBuddyApiKey'
  - bash: tools/setup_clang.sh /usr/lib/llvm-14
    displayName: Setup for Bazel build with clang
  - script: >
      bazel
      --batch_cpu_scheduling
      test
      --noshow_loading_progress
      --show_progress_rate_limit=5
      --verbose_failures
      --config=buildbuddy
      --remote_header=x-buildbuddy-api-key=$(BuildBuddyApiKey)
      --build_metadata=BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
      --build_metadata=COMMIT_SHA=$(git rev-parse HEAD)
      --build_metadata=ROLE=CI
      --compilation_mode opt
      --config=clang-asan
      --
      //...
      -//third_party/wangle:SSLContextManagerTest
    displayName: Test project
