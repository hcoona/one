# Copyright (c) 2022 Zhang Shuai<zhangshuai.ustc@gmail.com>.
# All rights reserved.
#
# This file is part of ONE.
#
# ONE is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# ONE is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# ONE. If not, see <https://www.gnu.org/licenses/>.

trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    include:
    - .azure-pipelines/distdir/official.yml
    - .bazelversion
    - WORKSPACE.bazel
    - requirements.txt

pr: none

pool:
  vmImage: ubuntu-22.04

jobs:
- job: build_distdir
  displayName: Generate distdir
  pool:
    vmImage: ubuntu-22.04
  steps:
  - template: /.azure-pipelines/common/generate_distdir.yml@self

- deployment: publish_distdir_prod
  displayName: Publish distdir to Azure blob
  pool:
    vmImage: windows-latest
  environment: production
  dependsOn: build_distdir
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: none
        - download: current
          artifact: distdir
        - task: AzureFileCopy@5
          inputs:
            sourcePath: '$(Pipeline.Workspace)/distdir/*'
            azureSubscription: 'Bazel'
            destination : 'Azure Blob'
            storage: 'zsbazelcache'
            containerName: 'one-distdir'
            blobPrefix: 'distdir2'
          displayName: Publish distdir to Azure storage account
