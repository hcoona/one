load("@rules_cc//cc:defs.bzl", "cc_library", "cc_test")

ARROW_FLAGS = [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/cmake_modules/SetupCxxFlags.cmake#L49
    "-msse4.2",
    "-mavx2",
    "-mbmi2",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/cmake_modules/SetupCxxFlags.cmake#L264
    "-Wall",
    "-Wno-conversion",
    "-Wno-deprecated-declarations",
    "-Wno-sign-conversion",
    "-Wno-unused-variable",
    # Add by me to suppress warnings
    "-Wno-sign-compare",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/cmake_modules/SetupCxxFlags.cmake#L429
    "-DARROW_HAVE_AVX2",
    "-DARROW_HAVE_BMI2",
    "-DARROW_HAVE_SSE4_2",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L265
    "-DURI_STATIC_BUILD",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L272
    "-DARROW_WITH_BZ2",
    "-DARROW_WITH_SNAPPY",
    "-DARROW_WITH_ZLIB",
    "-DARROW_WITH_ZSTD",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L524
    "-DARROW_WITH_BACKTRACE",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/CMakeLists.txt#L730
    "-DARROW_USE_GLOG",
]

##############
# Arrow
##############

# Extract SRCS variables from
# https://github.com/apache/arrow/blob/apache-arrow-4.0.0/cpp/src/arrow/CMakeLists.txt

ARROW_SRCS = [
    "array/array_base.cc",
    "array/array_binary.cc",
    "array/array_decimal.cc",
    "array/array_dict.cc",
    "array/array_nested.cc",
    "array/array_primitive.cc",
    "array/builder_adaptive.cc",
    "array/builder_base.cc",
    "array/builder_binary.cc",
    "array/builder_decimal.cc",
    "array/builder_dict.cc",
    "array/builder_nested.cc",
    "array/builder_primitive.cc",
    "array/builder_union.cc",
    "array/concatenate.cc",
    "array/data.cc",
    "array/diff.cc",
    "array/util.cc",
    "array/validate.cc",
    "builder.cc",
    "buffer.cc",
    "chunked_array.cc",
    "compare.cc",
    "config.cc",
    "datum.cc",
    "device.cc",
    "extension_type.cc",
    "memory_pool.cc",
    "pretty_print.cc",
    "record_batch.cc",
    "result.cc",
    "scalar.cc",
    "sparse_tensor.cc",
    "status.cc",
    "table.cc",
    "table_builder.cc",
    "tensor.cc",
    "tensor/coo_converter.cc",
    "tensor/csf_converter.cc",
    "tensor/csx_converter.cc",
    "type.cc",
    "visitor.cc",
    "c/bridge.cc",
    "io/buffered.cc",
    "io/caching.cc",
    "io/compressed.cc",
    "io/file.cc",
    "io/hdfs.cc",
    "io/hdfs_internal.cc",
    "io/interfaces.cc",
    "io/memory.cc",
    "io/slow.cc",
    "io/transform.cc",
    "util/basic_decimal.cc",
    "util/bit_block_counter.cc",
    "util/bit_run_reader.cc",
    "util/bit_util.cc",
    "util/bitmap.cc",
    "util/bitmap_builders.cc",
    "util/bitmap_ops.cc",
    "util/bpacking.cc",
    "util/cancel.cc",
    "util/compression.cc",
    "util/cpu_info.cc",
    "util/decimal.cc",
    "util/delimiting.cc",
    "util/formatting.cc",
    "util/future.cc",
    "util/int_util.cc",
    "util/io_util.cc",
    "util/logging.cc",
    "util/key_value_metadata.cc",
    "util/memory.cc",
    "util/mutex.cc",
    "util/string.cc",
    "util/string_builder.cc",
    "util/task_group.cc",
    "util/tdigest.cc",
    "util/thread_pool.cc",
    "util/time.cc",
    "util/trie.cc",
    "util/uri.cc",
    "util/utf8.cc",
    "util/value_parsing.cc",
    "vendored/base64.cpp",
    "vendored/datetime/tz.cpp",
    "vendored/double-conversion/bignum.cc",
    "vendored/double-conversion/double-conversion.cc",
    "vendored/double-conversion/bignum-dtoa.cc",
    "vendored/double-conversion/fast-dtoa.cc",
    "vendored/double-conversion/cached-powers.cc",
    "vendored/double-conversion/fixed-dtoa.cc",
    "vendored/double-conversion/diy-fp.cc",
    "vendored/double-conversion/strtod.cc",
] + [
    # Need avx2
    "util/bpacking_avx2.cc",
] + [
    # Need compression libraries
    "util/compression_bz2.cc",
    "util/compression_snappy.cc",
    "util/compression_zlib.cc",
    "util/compression_zstd.cc",
    # TODO(zhangshuai.ustc): Support other compressors.
    # "util/compression_brotil.cc",
    # "util/compression_lz4.cc",
]

ARROW_C_SRCS = [
    "vendored/musl/strptime.c",
    "vendored/uriparser/UriCommon.c",
    "vendored/uriparser/UriCompare.c",
    "vendored/uriparser/UriEscape.c",
    "vendored/uriparser/UriFile.c",
    "vendored/uriparser/UriIp4Base.c",
    "vendored/uriparser/UriIp4.c",
    "vendored/uriparser/UriMemory.c",
    "vendored/uriparser/UriNormalizeBase.c",
    "vendored/uriparser/UriNormalize.c",
    "vendored/uriparser/UriParseBase.c",
    "vendored/uriparser/UriParse.c",
    "vendored/uriparser/UriQuery.c",
    "vendored/uriparser/UriRecompose.c",
    "vendored/uriparser/UriResolve.c",
    "vendored/uriparser/UriShorten.c",
]

ARROW_CSV_SRCS = [
    "csv/converter.cc",
    "csv/chunker.cc",
    "csv/column_builder.cc",
    "csv/column_decoder.cc",
    "csv/options.cc",
    "csv/parser.cc",
    "csv/reader.cc",
]

ARROW_COMPUTE_SRCS = [
    "compute/api_aggregate.cc",
    "compute/api_scalar.cc",
    "compute/api_vector.cc",
    "compute/cast.cc",
    "compute/exec.cc",
    "compute/function.cc",
    "compute/kernel.cc",
    "compute/registry.cc",
    "compute/kernels/aggregate_basic.cc",
    "compute/kernels/aggregate_mode.cc",
    "compute/kernels/aggregate_quantile.cc",
    "compute/kernels/aggregate_tdigest.cc",
    "compute/kernels/aggregate_var_std.cc",
    "compute/kernels/codegen_internal.cc",
    "compute/kernels/hash_aggregate.cc",
    "compute/kernels/scalar_arithmetic.cc",
    "compute/kernels/scalar_boolean.cc",
    "compute/kernels/scalar_cast_boolean.cc",
    "compute/kernels/scalar_cast_internal.cc",
    "compute/kernels/scalar_cast_nested.cc",
    "compute/kernels/scalar_cast_numeric.cc",
    "compute/kernels/scalar_cast_string.cc",
    "compute/kernels/scalar_cast_temporal.cc",
    "compute/kernels/scalar_compare.cc",
    "compute/kernels/scalar_nested.cc",
    "compute/kernels/scalar_set_lookup.cc",
    "compute/kernels/scalar_string.cc",
    "compute/kernels/scalar_validity.cc",
    "compute/kernels/scalar_fill_null.cc",
    "compute/kernels/util_internal.cc",
    "compute/kernels/vector_hash.cc",
    "compute/kernels/vector_nested.cc",
    "compute/kernels/vector_selection.cc",
    "compute/kernels/vector_sort.cc",
] + [
    "compute/kernels/aggregate_basic_avx2.cc",
]

ARROW_DATASET_SRCS = [
    # Extract SRCS variables from
    # https://github.com/apache/arrow/blob/apache-arrow-4.0.0/cpp/src/arrow/dataset/CMakeLists.txt
    "dataset/dataset.cc",
    "dataset/discovery.cc",
    "dataset/expression.cc",
    "dataset/file_base.cc",
    "dataset/file_ipc.cc",
    "dataset/partition.cc",
    "dataset/projector.cc",
    "dataset/scanner.cc",
] + [
    "dataset/file_csv.cc",
    # Move parquet support into parquet library.
]

ARROW_FILESYSTEM_SRCS = [
    "filesystem/filesystem.cc",
    "filesystem/localfs.cc",
    "filesystem/mockfs.cc",
    "filesystem/path_util.cc",
    "filesystem/util_internal.cc",
    "filesystem/hdfs.cc",
]

ARROW_IPC_SRCS = [
    "ipc/dictionary.cc",
    "ipc/feather.cc",
    "ipc/message.cc",
    "ipc/metadata_internal.cc",
    "ipc/options.cc",
    "ipc/reader.cc",
    "ipc/writer.cc",
] + [
    # Need to include ARROW_JSON_SRCS as well.
    "ipc/json_simple.cc",
]

ARROW_JSON_SRCS = [
    "json/options.cc",
    "json/chunked_builder.cc",
    "json/chunker.cc",
    "json/converter.cc",
    "json/object_parser.cc",
    "json/object_writer.cc",
    "json/parser.cc",
    "json/reader.cc",
]

cc_library(
    name = "arrow",
    srcs = [
        "src/arrow/" + f
        for f in ARROW_SRCS + ARROW_C_SRCS + ARROW_CSV_SRCS + ARROW_COMPUTE_SRCS +
                 ARROW_DATASET_SRCS + ARROW_FILESYSTEM_SRCS + ARROW_IPC_SRCS + ARROW_JSON_SRCS
    ] + glob([
        "thirdparty/**/*.h",
    ]),
    hdrs = glob([
        "src/arrow/*.h",
        "src/arrow/**/*.h",
        "src/arrow/vendored/*.hpp",
    ]) + [
        "src/generated/feather_generated.h",
        "src/generated/File_generated.h",
        "src/generated/Message_generated.h",
        "src/generated/Schema_generated.h",
        "src/generated/SparseTensor_generated.h",
        "src/generated/Tensor_generated.h",
    ],
    copts = ARROW_FLAGS,
    defines = [
        # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L515
        "ARROW_STATIC",
    ],
    includes = [
        "src/",
    ],
    linkopts = [
        "-ldl",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "//third_party/bzip2:bz2",
        "//third_party/glog",
        "//third_party/rapidjson",
        "//third_party/snappy",
        "//third_party/xsimd",
        "//third_party/zlib",
        "//third_party/zstd",
    ],
)

ARROW_TESTING_SRCS = [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L297
    "io/test_common.cc",
    "ipc/test_common.cc",
    "testing/json_integration.cc",
    "testing/json_internal.cc",
    "testing/gtest_util.cc",
    "testing/random.cc",
    "testing/generator.cc",
    "testing/util.cc",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L360
    "csv/test_common.cc",
] + [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/CMakeLists.txt#L441
    "filesystem/test_util.cc",
]

cc_library(
    name = "arrow_test_common",
    testonly = 1,
    srcs = ["src/arrow/" + f for f in ARROW_TESTING_SRCS],
    deps = [
        ":arrow",
        "//third_party/googletest:gtest",
    ],
)

# Generated from add_arrow_test.

cc_test(
    name = "array_test",
    srcs = [
        "src/arrow/array/array_binary_test.cc",
        "src/arrow/array/array_dict_test.cc",
        "src/arrow/array/array_list_test.cc",
        "src/arrow/array/array_struct_test.cc",
        "src/arrow/array/array_test.cc",
        "src/arrow/array/array_union_test.cc",
        "src/arrow/array/array_view_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "buffer_test",
    srcs = [
        "src/arrow/buffer_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "extension_type_test",
    srcs = [
        "src/arrow/extension_type_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "misc_test",
    srcs = [
        "src/arrow/datum_test.cc",
        "src/arrow/memory_pool_test.cc",
        "src/arrow/pretty_print_test.cc",
        "src/arrow/result_test.cc",
        "src/arrow/status_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "public_api_test",
    srcs = [
        "src/arrow/public_api_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "scalar_test",
    srcs = [
        "src/arrow/scalar_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "type_test",
    srcs = [
        "src/arrow/type_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "table_test",
    srcs = [
        "src/arrow/chunked_array_test.cc",
        "src/arrow/record_batch_test.cc",
        "src/arrow/table_builder_test.cc",
        "src/arrow/table_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "tensor_test",
    srcs = [
        "src/arrow/tensor_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "sparse_tensor_test",
    srcs = [
        "src/arrow/sparse_tensor_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "stl_iterator_test",
    srcs = [
        "src/arrow/stl_iterator_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "stl_test",
    srcs = [
        "src/arrow/stl_test.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "builder_benchmark",
    size = "large",
    srcs = [
        "src/arrow/builder_benchmark.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/benchmark:benchmark_main",
    ],
)

cc_test(
    name = "compare_benchmark",
    size = "large",
    srcs = [
        "src/arrow/compare_benchmark.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/benchmark:benchmark_main",
    ],
)

cc_test(
    name = "memory_pool_benchmark",
    size = "large",
    srcs = [
        "src/arrow/memory_pool_benchmark.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/benchmark:benchmark_main",
    ],
)

cc_test(
    name = "type_benchmark",
    size = "large",
    srcs = [
        "src/arrow/type_benchmark.cc",
    ],
    deps = [
        ":arrow",
        ":arrow_test_common",
        "//third_party/benchmark:benchmark_main",
    ],
)

cc_binary(
    name = "libarrow_dataset_jni.so",
    srcs = [
        "src/jni/dataset/jni_util.cc",
        "src/jni/dataset/jni_util.h",
        "src/jni/dataset/jni_wrapper.cc",
        "//third_party/arrow_java/dataset:dataset_native_header",
    ],
    linkshared = True,
    visibility = ["//visibility:public"],
    deps = [
        ":arrow",
        ":parquet",
        "//third_party/jni:jni_headers",
    ],
)

##############
# Parquet
##############

PARQUET_SRCS = [
    # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/parquet/CMakeLists.txt#L148
    "arrow/path_internal.cc",
    "arrow/reader.cc",
    "arrow/reader_internal.cc",
    "arrow/schema.cc",
    "arrow/schema_internal.cc",
    "arrow/writer.cc",
    "bloom_filter.cc",
    "column_reader.cc",
    "column_scanner.cc",
    "column_writer.cc",
    "encoding.cc",
    "encryption/encryption.cc",
    "encryption/internal_file_decryptor.cc",
    "encryption/internal_file_encryptor.cc",
    "exception.cc",
    "file_reader.cc",
    "file_writer.cc",
    "level_comparison.cc",
    "level_conversion.cc",
    "metadata.cc",
    "murmur3.cc",
    "platform.cc",
    "printer.cc",
    "properties.cc",
    "schema.cc",
    "statistics.cc",
    "stream_reader.cc",
    "stream_writer.cc",
    "types.cc",
] + [
    # https://github.com/apache/arrow/blob/d613aa68789288d3503dfbd8376a41f2d28b6c9d/cpp/src/parquet/CMakeLists.txt#L207
    "level_comparison_avx2.cc",
    "level_conversion_bmi2.cc",
] + [
    # https://github.com/apache/arrow/blob/d613aa68789288d3503dfbd8376a41f2d28b6c9d/cpp/src/parquet/CMakeLists.txt#L228
    "encryption/encryption_internal.cc",
]

cc_library(
    name = "parquet",
    srcs = ["src/parquet/" + f for f in PARQUET_SRCS] + [
        "src/generated/parquet_types.cpp",
        "src/generated/parquet_types.h",
        "src/generated/parquet_constants.cpp",
        "src/generated/parquet_constants.h",
    ] + [
        # https://github.com/apache/arrow/blob/f959141ece4d660bce5f7fa545befc0116a7db79/cpp/src/arrow/dataset/CMakeLists.txt#L120
        "src/arrow/dataset/file_parquet.cc",
    ],
    hdrs = glob([
        "src/parquet/*.h",
        "src/parquet/**/*.h",
    ]),
    copts = ARROW_FLAGS,
    visibility = ["//visibility:public"],
    deps = [
        ":arrow",
        "//third_party/thrift",
    ],
)

# Generated from add_parquet_test

# Lack of parquet-testing data folder.
# cc_test(
#     name = "internals-test",
#     srcs = [
#         "src/parquet/bloom_filter_test.cc",
#         "src/parquet/deprecated_io_test.cc",
#         "src/parquet/encoding_test.cc",
#         "src/parquet/metadata_test.cc",
#         "src/parquet/properties_test.cc",
#         "src/parquet/public_api_test.cc",
#         "src/parquet/statistics_test.cc",
#         "src/parquet/test_util.cc",
#         "src/parquet/types_test.cc",
#     ],
#     deps = [
#         ":arrow_test_common",
#         ":parquet",
#         "//third_party/googletest:gtest_main",
#     ],
# )

# cc_test(
#     name = "reader_test",
#     srcs = [
#         "src/parquet/column_reader_test.cc",
#         "src/parquet/column_scanner_test.cc",
#         "src/parquet/level_conversion_test.cc",
#         "src/parquet/reader_test.cc",
#         "src/parquet/stream_reader_test.cc",
#         "src/parquet/test_util.cc",
#     ],
#     deps = [
#         ":arrow_test_common",
#         ":parquet",
#         "//third_party/googletest:gtest_main",
#     ],
# )

cc_test(
    name = "writer_test",
    srcs = [
        "src/parquet/column_writer_test.cc",
        "src/parquet/file_serialize_test.cc",
        "src/parquet/stream_writer_test.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/googletest:gtest_main",
    ],
)

# Lack of parquet-testing data folder.
# cc_test(
#     name = "arrow-test",
#     srcs = [
#         "src/parquet/arrow/arrow_reader_writer_test.cc",
#         "src/parquet/arrow/arrow_schema_test.cc",
#         "src/parquet/test_util.cc",
#     ],
#     deps = [
#         ":arrow_test_common",
#         ":parquet",
#         "//third_party/googletest:gtest_main",
#     ],
# )

cc_test(
    name = "arrow-internals-test",
    srcs = [
        "src/parquet/arrow/path_internal_test.cc",
        "src/parquet/arrow/reconstruct_internal_test.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/googletest:gtest_main",
    ],
)

# Lack of parquet-testing data folder.
# cc_test(
#     name = "encryption-test",
#     srcs = [
#         "src/parquet/encryption_properties_test.cc",
#         "src/parquet/encryption_read_configurations_test.cc",
#         "src/parquet/encryption_write_configurations_test.cc",
#         "src/parquet/test_util.cc",
#     ],
#     deps = [
#         ":arrow_test_common",
#         ":parquet",
#         "//third_party/googletest:gtest_main",
#     ],
# )

cc_test(
    name = "file_deserialize_test",
    srcs = [
        "src/parquet/file_deserialize_test.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "schema_test",
    srcs = [
        "src/parquet/schema_test.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "column_io_benchmark",
    size = "large",
    srcs = [
        "src/parquet/column_io_benchmark.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/benchmark:benchmark_main",
    ],
)

# cc_test(
#     name = "encoding_benchmark",
#     size = "large",
#     srcs = [
#         "src/parquet/encoding_benchmark.cc",
#         "src/parquet/test_util.cc",
#     ],
#     deps = [
#         ":arrow_test_common",
#         ":parquet",
#         "//third_party/benchmark:benchmark_main",
#     ],
# )

cc_test(
    name = "level_conversion_benchmark",
    size = "large",
    srcs = [
        "src/parquet/level_conversion_benchmark.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/benchmark:benchmark_main",
    ],
)

cc_test(
    name = "arrow_reader_writer_benchmark",
    size = "large",
    srcs = [
        "src/parquet/arrow/reader_writer_benchmark.cc",
        "src/parquet/test_util.cc",
    ],
    deps = [
        ":arrow_test_common",
        ":parquet",
        "//third_party/benchmark:benchmark_main",
    ],
)
