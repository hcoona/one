load("@rules_cc//cc:defs.bzl", "cc_library", "cc_test")

SNAPPY_MSVC_FLAGS = [
    # Use the highest warning level for Visual Studio.
    "/W4",
    # Disable C++ exceptions.
    "/EHs-c-",
    "-D_HAS_EXCEPTIONS=0",
    # Disable RTTI.
    "/GR-",
    # AVX
    "/arch:AVX",
]

SNAPPY_CLANG_GCC_COMMON_FLAGS = [
    # Use -Wall for clang and gcc.
    "-Wall",
    # Use -Wextra for clang and gcc.
    "-Wextra",
    # Disable C++ exceptions.
    "-fno-exceptions",
    # Disable RTTI.
    "-fno-rtti",
    # AVX
    "-mavx",
    "-mbmi2",
]

SNAPPY_CLANG_FLAGS = SNAPPY_CLANG_GCC_COMMON_FLAGS + [
    # Use -Werror for clang only.
    "-Werror",
]

cc_library(
    name = "snappy",
    srcs = [
        "config.h",
        "snappy.cc",
        "snappy-c.cc",
        "snappy-internal.h",
        "snappy-sinksource.cc",
        "snappy-stubs-internal.cc",
        "snappy-stubs-internal.h",
    ],
    hdrs = [
        "snappy.h",
        "snappy-c.h",
        "snappy-sinksource.h",
        "snappy-stubs-public.h",
    ],
    copts = SNAPPY_CLANG_GCC_COMMON_FLAGS,
    local_defines = [
        "HAVE_CONFIG_H",
    ],
    visibility = ["//visibility:public"],
)

cc_library(
    name = "snappy_test_support",
    testonly = 1,
    srcs = [
        "config.h",
        "snappy-test.cc",
        "snappy-test.h",
        "snappy_test_data.cc",
        "snappy_test_data.h",
    ],
    data = [
        "testdata/alice29.txt",
        "testdata/asyoulik.txt",
        "testdata/baddata1.snappy",
        "testdata/baddata2.snappy",
        "testdata/baddata3.snappy",
        "testdata/fireworks.jpeg",
        "testdata/geo.protodata",
        "testdata/html",
        "testdata/html_x_4",
        "testdata/kppkn.gtb",
        "testdata/lcet10.txt",
        "testdata/paper-100k.pdf",
        "testdata/plrabn12.txt",
        "testdata/urls.10K",
    ],
    defines = [
        "HAVE_CONFIG_H",
    ],
    deps = [
        ":snappy",
        "//third_party/zlib",
        "@bazel_tools//tools/cpp/runfiles",
    ],
)

cc_test(
    name = "snappy_unittest",
    srcs = [
        "snappy_unittest.cc",
    ],
    deps = [
        ":snappy_test_support",
        "//third_party/googletest:gtest_main",
    ],
)

cc_test(
    name = "snappy_benchmark",
    size = "large",
    srcs = [
        "snappy_benchmark.cc",
    ],
    deps = [
        ":snappy_test_support",
        "//third_party/benchmark:benchmark_main",
    ],
)
